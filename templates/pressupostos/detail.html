{% extends "base.html" %}
{% block content %}

<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
    <h2 class="mb-0">Versions del Pressupost</h2>
    <div class="d-flex gap-2">
      <a href="{% url 'pressupostos:generar_pdf' pressupost.pk %}" class="btn btn-dark">
        <i class="bi bi-file-earmark-plus"></i> Generar nova versi√≥ PDF
      </a>
      <a href="{% url 'pressupostos:list' %}" class="btn btn-outline-dark">
        <i class="bi bi-arrow-left-circle"></i> Tornar a la llista
      </a>
    </div>
  </div>

  <div class="mb-3">
    <p><strong>Nom:</strong> {{ pressupost.nom }}</p>
    <p><strong>Client:</strong> {{ pressupost.client }}</p>
    <p><strong>Projecte:</strong> {{ pressupost.projecte }}</p>
  </div>

  {% if versions %}
    <div class="table-responsive">
      <table class="table table-bordered table-hover align-middle bg-white table-dark-header">
        <thead class="table-dark text-white">
          <tr>
            <th>Versi√≥</th>
            <th>Data generaci√≥</th>
            <th>Usuari</th>
            <th class="text-center">Accions</th>
          </tr>
        </thead>
        <tbody>
          {% for version in versions %}
            <tr id="row-version-{{ version.id }}">
              <td>{{ version.version }}</td>
              <td>{{ version.data_generat|date:"d/m/Y H:i" }}</td>
              <td>{{ version.generat_per }}</td>
              <td class="text-center">
                <div class="d-flex justify-content-center gap-2 flex-wrap">
                  <a href="{{ version.arxiu.url }}" target="_blank" class="btn btn-sm btn-outline-secondary" title="Veure PDF">
                    <i class="bi bi-eye"></i> 
                  </a>
                  <button type="button"
                          class="btn btn-sm btn-outline-danger btn-delete-version"
                          data-id="{{ version.id }}"
                          title="Eliminar versi√≥">
                    <i class="bi bi-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <div class="alert alert-light border">
      Encara no hi ha cap versi√≥ PDF registrada per aquest pressupost.
    </div>
  {% endif %}
</div>

<!-- üîí Modal confirmaci√≥ -->
<div class="modal fade" id="confirmDeleteVersionModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirmar eliminaci√≥</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Tancar"></button>
      </div>
      <div class="modal-body">
        Segur que vols eliminar aquesta versi√≥ PDF?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-dark" data-bs-dismiss="modal">Cancel¬∑lar</button>
        <button type="button" id="confirmDeleteVersionBtn" class="btn btn-dark">Eliminar</button>
      </div>
    </div>
  </div>
</div>

<!-- ‚úÖ Toast d'√®xit -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1080;">
  <div id="successVersionToast" class="toast bg-light border-dark" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-header bg-dark text-white">
      ‚úÖ Versi√≥ eliminada
      <button type="button" class="btn-close btn-close-white ms-auto" data-bs-dismiss="toast" aria-label="Tancar"></button>
    </div>
    <div class="toast-body">
      Versi√≥ PDF eliminada correctament.
    </div>
  </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
  document.addEventListener("DOMContentLoaded", () => {
    let versionIdToDelete = null;

    document.querySelectorAll(".btn-delete-version").forEach(btn => {
      btn.addEventListener("click", () => {
        versionIdToDelete = btn.dataset.id;
        const modal = new bootstrap.Modal(document.getElementById('confirmDeleteVersionModal'));
        modal.show();
      });
    });

    document.getElementById("confirmDeleteVersionBtn").addEventListener("click", () => {
      if (!versionIdToDelete) return;

      fetch(`/pressupostos/delete_version_ajax/${versionIdToDelete}/`, {
        method: "POST",
        headers: {
          "X-CSRFToken": getCookie("csrftoken"),
        }
      })
      .then(res => res.json())
      .then(data => {
        const row = document.getElementById(`row-version-${versionIdToDelete}`);
        if (data.success && row) {
          row.classList.add("fade");
          row.style.transition = "opacity 0.5s ease-out";
          row.style.opacity = "0";
          setTimeout(() => row.remove(), 500);
          new bootstrap.Toast(document.getElementById('successVersionToast')).show();
        } else {
          alert("‚ùå Error: " + (data.error || "No s'ha pogut eliminar."));
        }
        bootstrap.Modal.getInstance(document.getElementById('confirmDeleteVersionModal')).hide();
      });
    });

    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === name + "=") {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
  });
</script>
{% endblock %}
